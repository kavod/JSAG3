JSAG={SIMPLE_TYPES:["string","password","choices","integer","hostname","boolean","file","email"],SCHEMA:{},VALUES:{},getType:function(e,t){if("undefined"==typeof t&&(t=[]),configParser=e,t.length>0&&$.each(t,function(e,t){configParser=t===parseInt(t,10)?configParser.items:configParser.properties[t]}),"type"in configParser)return configParser.type;if("format"in configParser)return configParser.format;if("$def"in configParser){if(defRegex=/^#\/def\/(\w+)/i,myType=defRegex.exec(configParser.$def),myType)return myType[1];if(defRegex=/^#\/choices\/(\w+)$/i,myType=defRegex.exec(configParser.$def),myType)return"choices"}return""},form_generate:function(e,t,r,i,n,a){"undefined"==typeof r&&(r=!1),"undefined"==typeof n&&(n="%s: "),"undefined"==typeof a&&(a=0),myDefault="undefined"==typeof i?"default"in t?t["default"]:"":i;var d;return"object"==JSAG.getType(t)?(d=$("<fieldset>").attr("id",e).append($("<legend>").html(n.replace("%s",t.title))),sortedItems=[],$.each(t.properties,function(e,t){sortedItems.push({id:e,order:t.order,item:t})}),sortedItems=sortedItems.sort(function(e,t){return"order"in e||(e.order=0),"order"in t||(t.order=0),e.order>t.order}),map=[],$.each(sortedItems,function(n,o){item_id=JSAG.full_id(e,o.id),r="required"in t&&t.required.indexOf(o.id)>-1,value="undefined"!=typeof i&&o.id in i?i[o.id]:void 0,nodeItem=JSAG.form_generate(item_id,o.item,r,value,"%s",a+1),d.append(nodeItem),map[o.id]=item_id}),d):"array"==JSAG.getType(t)?(d=$("<fieldset>").attr("id",e).append($("<legend>").html(n.replace("%s",t.title))),newNode=$("<a href></a>").html("Add %s".replace("%s",t.title)).attr("id","new_"+e).addClass("new").on("click",function(r){r.preventDefault(),defRegex=/^(.*)_([0-9]+)$/i,myID=defRegex.exec($("#"+r.target.id).prev()[0].id),JSAG.updateValuesCache(r.target.closest("form")),JSAG.getFromJSON(JSAG.VALUES,e).push(JSAG.getFromJSON($("<form>").append(JSAG.form_generate(e+"_",t.items,!0,void 0,"Add %s",a+1)).serializeObject(),e+"_0")),JSAG.updateForms()}),d.append(newNode),d):"password"==JSAG.getType(t)?d=$("<div>").append($("<label>").html(n.replace("%s",t.title)).addClass("nv"+a).attr("for",e)).append($("<input>").attr("type","password").attr("placeholder",t.placeholder).attr("name",JSAG.idToName(e)).attr("id",e).prop("required",r)):"integer"==JSAG.getType(t)?(inputNode=$("<input>").attr("type","number").attr("placeholder",t.placeholder).attr("name",JSAG.idToName(e)).attr("id",e).prop("required",r),"minimum"in t&&inputNode.attr("min","exclusiveMinimum"in t&&t.exclusiveMinimum?parseInt(t.minimum)+1:t.minimum),"maximum"in t&&inputNode.attr("max","exclusiveMaximum"in t&&t.exclusiveMaximum?parseInt(t.maximum)-1:t.maximum),d=$("<div>").append($("<label>").html(n.replace("%s",t.title)).addClass("nv"+a).attr("for",e)).append(inputNode)):"email"==JSAG.getType(t)?d=$("<div>").append($("<label>").html(n.replace("%s",t.title)).addClass("nv"+a).attr("for",e)).append($("<input>").attr("type","email").attr("placeholder",t.placeholder).attr("name",JSAG.idToName(e)).attr("id",e).prop("required",r)):"boolean"==JSAG.getType(t)?(nodeSelect=$("<input>").attr("type","checkbox").attr("name",JSAG.idToName(e)).attr("id",e),d=$("<div>").append($("<label>").html(n.replace("%s",t.title)).addClass("nv"+a).attr("for",e)).append(nodeSelect)):"choices"==JSAG.getType(t)?(nodeSelect=$("<select>").attr("name",JSAG.idToName(e)).attr("id",e).prop("required",r),nodeSelect.append($("<option>").attr("value","").html(t.description)),defRegex=/^#\/choices\/(\w+)/i,myType=defRegex.exec(t.$def),myType&&(choices=t.choices[myType[1]],$.each(choices,function(e,t){nodeSelect.append($("<option>").attr("value",e).html(t))})),d=$("<div>").append($("<label>").html(n.replace("%s",t.title)).addClass("nv"+a).attr("for",e)).append(nodeSelect)):JSAG.SIMPLE_TYPES.indexOf(JSAG.getType(t))>-1?d=$("<div>").append($("<label>").html(n.replace("%s",t.title)).addClass("nv"+a).attr("for",e)).append($("<input>").attr("name",JSAG.idToName(e)).attr("id",e).attr("placeholder",t.placeholder).prop("required",r)):void 0},form_setValue:function(e,t,r,i){"undefined"==typeof i&&(i=0),myDefault="undefined"==typeof r?"default"in t?t["default"]:"":r;var n;"object"==JSAG.getType(t)?(sortedItems=[],$.each(t.properties,function(e,t){sortedItems.push({id:e,order:t.order,item:t})}),sortedItems=sortedItems.sort(function(e,t){return"order"in e||(e.order=0),"order"in t||(t.order=0),e.order>t.order}),$.each(sortedItems,function(t,n){item_id=JSAG.full_id(e,n.id),value="undefined"!=typeof r&&n.id in r?r[n.id]:void 0,JSAG.form_setValue(item_id,n.item,value,i+1)})):"array"==JSAG.getType(t)?($("#"+e+">:not(.new):not(legend)").remove(),void 0!=r&&(n=$("#"+e+">.new"),$.each(r,function(r,a){n.before(JSAG.form_generate(e+"_"+r,t.items,!0,a,"%s "+(r+1),i+1).append($("<input>").attr("type","button").attr("value","Delete").on("click",function(t){$("#"+e+"_"+r).parent().remove(),JSAG.updateValuesCache(t.target.closest("form")),JSAG.updateForms()})))}),$.each(r,function(r,n){JSAG.form_setValue(e+"_"+r,t.items,n,i+1)}))):"password"==JSAG.getType(t)?$("#"+e).val(myDefault):"integer"==JSAG.getType(t)?$("#"+e).val(myDefault):"email"==JSAG.getType(t)?$("#"+e).val(myDefault):"boolean"==JSAG.getType(t)?(nodeSelect=$("#"+e),nodeSelect.prop("checked",myDefault)):"choices"==JSAG.getType(t)?(nodeSelect=$("#"+e),nodeSelect.val(myDefault)):JSAG.SIMPLE_TYPES.indexOf(JSAG.getType(t))>-1&&$("#"+e).val(myDefault)},create_events:function(e,t,r){var i;return"object"==JSAG.getType(t)?(i=0,sortedItems=[],$.each(t.properties,function(e,t){sortedItems.push({id:e,order:t.order,item:t})}),sortedItems=sortedItems.sort(function(e,t){return"order"in e||(e.order=0),"order"in t||(t.order=0),e.order>t.order}),map=[],$.each(sortedItems,function(t,n){value="undefined"!=typeof r&&n.id in r?r[n.id]:void 0,item_id=JSAG.full_id(e,n.id),cur_left=JSAG.create_events(item_id,n.item,value),i=i<cur_left?cur_left:i,map[n.id]=item_id}),"conditions"in t&&$.each(t.conditions,function(t,r){myevent=Object.create(r),myevent.if_val=r.if_val.slice(0),index=myevent.if_val.indexOf(null),-1!=index&&(myevent.if_val[index]=""),myevent.map=map,myevent.if_prop=JSAG.full_id(e,myevent.if_prop),myevent.then_prop=JSAG.full_id(e,myevent.then_prop),$("#"+myevent.if_prop).on("change",myevent,JSAG.show_hide),JSAG.show_hide({data:myevent})}),i):"array"!=JSAG.getType(t)?$("#"+e).offset().left:(i=0,void(void 0!=r&&$.each(r,function(r,n){cur_left=JSAG.create_events(e+"_"+r,t.items,n),i=i<cur_left?cur_left:i})))},create_form:function(e,t,r,i){return"undefined"==typeof i&&(i={}),e.html(""),formNode=$("<form>").append(JSAG.form_generate(t,r,!1,i)).append($("<input>").attr("type","submit").attr("id",t+"_submit")),e.append(formNode),JSAG.SCHEMA[t]=r,JSAG.VALUES[t]=jQuery.isEmptyObject(i)?"object"==JSAG.getType(r)?{}:"array"==JSAG.getType(r)?[]:"":i,JSAG.updateForms(),formNode},updateValuesCache:function(e){JSAG.VALUES=$(e).serializeObject()},updateForms:function(){for(key in JSAG.VALUES)JSAG.form_setValue(key,JSAG.SCHEMA[key],JSAG.VALUES[key]),JSAG.create_events(key,JSAG.SCHEMA[key],JSAG.VALUES[key]),JSAG.align_values(JSAG.SCHEMA[key],JSAG.VALUES[key])},show_hide:function(e){var t=$("#"+e.data.if_prop)[0];value="checkbox"==t.type?t.checked:t.value,e.data.if_val.indexOf(value)>-1?($("#"+e.data.then_prop).hide(),$("#"+e.data.then_prop+" *[required]").addClass("hidden_required_field"),$("#"+e.data.then_prop+" .hidden_required_field").prop("required",!1)):($("#"+e.data.then_prop+" .hidden_required_field").prop("required",!0),$("#"+e.data.then_prop+" .hidden_required_field").removeClass("hidden_required_field"),$("#"+e.data.then_prop).show())},align_values:function(){for(var e=Array(9),t=1;10>t;t++)$("label.nv"+t.toString()).css("width","auto");for(var r=JSAG.maxLeft("input,select"),t=1;10>t;t++)e[t]=JSAG.maxLeft("label.nv"+t.toString());$("label").css("display","inline-block");for(var t=1;10>t;t++)$("label.nv"+t.toString()).css("width",r-e[t]+10)},maxLeft:function(e){return Math.max.apply(null,$(e).map(function(){return $(this).offset().left}).get())},full_id:function(e,t){return e+(e.length>0?"_"+t:t)},idToName:function(e){for(;e!=e.replace(new RegExp("^([^_]+)_([^_]*)(.*)$"),"$1[$2]$3");)e=e.replace(new RegExp("^([^_]+)_([^_]*)(.*)$"),"$1[$2]$3");return e},getFromJSON:function(e,t){regex_str="^([^_]+)_(.*)$",result=e;for(var r=t.match(new RegExp(regex_str));r;)t=t.replace(new RegExp(regex_str),"$2"),result=result[r[1]],r=t.match(new RegExp(regex_str));return t in result||(result[t]=[]),result[t]}};
